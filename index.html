<script>
    // ... (le reste du code reste identique jusqu'à la fonction handleDrop)

    function handleDrop(e) {
        e.preventDefault();
        if (!draggedPiece) return;
        
        const slot = e.target.closest('.puzzle-slot');
        if (!slot) return;
        
        const slotKey = slot.dataset.key;
        const pieceToPlace = draggedPiece;
        
        // Si la case cible est occupée, on récupère la pièce existante
        let existingPiece = null;
        if (placedPieces[slotKey]) {
            existingPiece = document.getElementById(placedPieces[slotKey]);
        }
        
        // Si la pièce vient d'une autre case
        if (draggedPieceOrigin !== 'pieces-container') {
            const originSlot = document.querySelector(`.puzzle-slot[data-key="${draggedPieceOrigin}"]`);
            if (originSlot) {
                // On place la pièce existante (si elle existe) dans l'emplacement d'origine
                if (existingPiece) {
                    const pieceCopy = existingPiece.cloneNode();
                    pieceCopy.className = 'piece-in-slot';
                    pieceCopy.style.backgroundImage = existingPiece.style.backgroundImage;
                    pieceCopy.style.backgroundPosition = existingPiece.style.backgroundPosition;
                    pieceCopy.addEventListener('dragstart', handleDragStart);
                    
                    originSlot.innerHTML = '';
                    originSlot.appendChild(pieceCopy);
                    placedPieces[draggedPieceOrigin] = existingPiece.id;
                } else {
                    originSlot.innerHTML = '';
                    delete placedPieces[draggedPieceOrigin];
                }
            }
        } else if (existingPiece) {
            // Si on vient de la zone de pièces et qu'il y a une pièce dans la case
            existingPiece.style.display = 'block';
            document.getElementById('pieces-container').appendChild(existingPiece);
        }
        
        // Placer la nouvelle pièce
        const pieceCopy = pieceToPlace.cloneNode();
        pieceCopy.className = 'piece-in-slot';
        pieceCopy.style.backgroundImage = pieceToPlace.style.backgroundImage;
        pieceCopy.style.backgroundPosition = pieceToPlace.style.backgroundPosition;
        pieceCopy.addEventListener('dragstart', handleDragStart);
        
        slot.innerHTML = '';
        slot.appendChild(pieceCopy);
        
        if (draggedPieceOrigin === 'pieces-container') {
            pieceToPlace.style.display = 'none';
        }
        
        placedPieces[slotKey] = pieceToPlace.id;
        checkVictory();
    }

    // ... (le reste du code reste identique)
</script>
